name: 'Web App Pr Checks'
on:
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-check
  cancel-in-progress: true

jobs:
  path-check:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.filter.outputs.should_run }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            should_run:
              - 'js/app/package.json'
              - 'js/app/bun.lock'
              - 'js/app/packages/**'
              - 'js/app/src/**'
              - '.github/actions/setup-reqs-web/**'
              - '.github/workflows/web-app-check-main.yml'

  typescript:
    needs: path-check
    if: needs.path-check.outputs.should_run == 'true'
    name: Typecheck
    runs-on: linux-latest-beefy
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
      - name: Setup Prereqs
        uses: ./.github/actions/setup-reqs-web
        with:
          npm-rc-token: ${{ secrets.NPMRC_GH_TOKEN }}
      - name: Generate API Types
        working-directory: js/app
        run: bun run gen-api
      - name: Check Types
        working-directory: js/app
        run: |
          bun run --bun --silent tsc --project ./packages/app/tsconfig.json

  biome-check:
    needs: path-check
    if: needs.path-check.outputs.should_run == 'true'
    name: Biome Check
    runs-on: linux-latest-middy
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Biome
        uses: biomejs/setup-biome@v2
        with:
          version: 2.2.6
      - name: Run Biome
        working-directory: js/app
        run: biome ci --changed --no-errors-on-unmatched

  tailwind:
    needs: path-check
    if: needs.path-check.outputs.should_run == 'true'
    name: Theme Hygiene Inspector
    runs-on: linux-latest-middy
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Prereqs
        uses: ./.github/actions/setup-reqs-web
        with:
          npm-rc-token: ${{ secrets.NPMRC_GH_TOKEN }}
      - name: Check Tailwind Classes
        working-directory: js/app
        run: bun run check-tailwind

  test:
    needs: path-check
    if: needs.path-check.outputs.should_run == 'true'
    name: Test
    runs-on: linux-latest-middy
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
      - name: Setup
        uses: ./.github/actions/setup-reqs-web
        with:
          npm-rc-token: ${{ secrets.NPMRC_GH_TOKEN }}
      - name: Test
        working-directory: js/app
        run: bunx vitest

  cycles:
    needs: path-check
    if: needs.path-check.outputs.should_run == 'true'
    name: Cycles Import Check
    runs-on: linux-latest-middy
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Biome
        uses: biomejs/setup-biome@v2
        with:
          version: latest
      - name: Cycles Import Check
        working-directory: js/app
        run: biome lint --changed --no-errors-on-unmatched --only=nursery/noImportCycles

  build:
    needs: path-check
    if: needs.path-check.outputs.should_run == 'true'
    name: Build
    runs-on: linux-latest-middy
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
      - name: Setup
        uses: ./.github/actions/setup-reqs-web
        with:
          npm-rc-token: ${{ secrets.NPMRC_GH_TOKEN }}
      - name: Build
        working-directory: js/app
        run: bun run build

  # Collector job that always runs - use this as the required status check
  status-check:
    name: Web App Status Check
    if: always()
    needs: [path-check, typescript, biome-check, tailwind, test, cycles, build]
    runs-on: ubuntu-latest
    steps:
      - name: Check job results
        run: |
          echo "path-check: ${{ needs.path-check.result }}"
          echo "typescript: ${{ needs.typescript.result }}"
          echo "biome-check: ${{ needs.biome-check.result }}"
          echo "tailwind: ${{ needs.tailwind.result }}"
          echo "test: ${{ needs.test.result }}"
          echo "cycles: ${{ needs.cycles.result }}"
          echo "build: ${{ needs.build.result }}"

          # Fail if any job failed (skipped and success are both OK)
          if [[ "${{ needs.path-check.result }}" == "failure" ]] || \
             [[ "${{ needs.typescript.result }}" == "failure" ]] || \
             [[ "${{ needs.biome-check.result }}" == "failure" ]] || \
             [[ "${{ needs.tailwind.result }}" == "failure" ]] || \
             [[ "${{ needs.test.result }}" == "failure" ]] || \
             [[ "${{ needs.cycles.result }}" == "failure" ]] || \
             [[ "${{ needs.build.result }}" == "failure" ]]; then
            echo "❌ One or more jobs failed"
            exit 1
          fi

          echo "✅ All jobs passed or were skipped"

