name: Deploy All Services
on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        required: true
        default: 'dev'
        options:
          - dev
          - prod
        description: The environment we are deploying to.

# Only run 1 deploy-all workflow at a time per environment
concurrency:
  group: ${{ github.workflow }}-all-services-${{ inputs.environment }}
  cancel-in-progress: false

jobs:
  setup:
    name: Setup Deployment Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - name: Set deployment matrix
        id: set-matrix
        run: |
          # Get all services
          services=$(jq -r '.services | keys | @json' .github/services-config.json)
          echo "matrix=${services}" >> $GITHUB_OUTPUT
          echo "Deploying services: ${services}"

  deploy-services:
    name: Deploy ${{ matrix.service }}
    needs: setup
    if: ${{ needs.setup.outputs.matrix != '[]' }}
    runs-on:
      [
        runs-on,
        runner=8cpu-linux-x64,
        hdd=40,
        spot=false,
        ssh=false,
        'run-id=${{github.run_id}}',
      ]
    strategy:
      fail-fast: false
      max-parallel: 20  # Limit concurrent deployments
      matrix:
        service: ${{ fromJson(needs.setup.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Get project name
        id: project-name
        uses: ./.github/actions/get-project-name
        with:
          service-name: ${{ matrix.service }}

      - name: Deploy ${{ matrix.service }}
        uses: ./.github/actions/deploy-cloud-storage-pulumi
        with:
          environment: ${{ inputs.environment }}
          aws-access-key: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          pulumi-access-token: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          pulumi-service-name: ${{ steps.project-name.outputs.project-name }}
          dd-app-key: ${{ secrets.DD_APP_KEY }}
          dd-api-key: ${{ secrets.DD_API_KEY }}

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: deploy-services
    if: always()
    steps:
      - name: Check deployment results
        run: |
          if [[ "${{ needs.deploy-services.result }}" == "failure" ]]; then
            echo "❌ One or more service deployments failed"
            exit 1
          elif [[ "${{ needs.deploy-services.result }}" == "skipped" ]]; then
            echo "⏭️ No services to deploy"
          else
            echo "✅ All service deployments completed successfully for ${{ inputs.environment }} environment"
          fi
