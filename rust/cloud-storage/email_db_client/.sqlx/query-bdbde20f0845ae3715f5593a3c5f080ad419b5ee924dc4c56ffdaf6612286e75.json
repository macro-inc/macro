{
  "db_name": "PostgreSQL",
  "query": "\n        SELECT\n            a.id AS attachment_db_id,\n            m.provider_id as \"email_provider_id!\",\n            a.provider_attachment_id as \"provider_attachment_id!\",\n            a.filename as \"filename!\",\n            a.mime_type as \"mime_type!\",\n            m.internal_date_ts as \"internal_date_ts!\"\n        FROM email_attachments a\n        JOIN email_messages m ON a.message_id = m.id\n        WHERE m.thread_id = $1\n            AND a.mime_type NOT LIKE 'image/%'\n            AND a.mime_type NOT LIKE '%zip%'\n            AND a.mime_type NOT IN ('application/ics', 'application/x-sharing-metadata-xml')\n            AND EXISTS ( -- only fetch if at least one message in the thread meets any of the criteria\n                SELECT 1\n                FROM email_messages m2\n                LEFT JOIN email_message_labels ml ON m2.id = ml.message_id\n                LEFT JOIN email_labels l ON ml.label_id = l.id\n                LEFT JOIN email_contacts c ON m2.from_contact_id = c.id\n                JOIN email_threads t ON m2.thread_id = t.id\n                JOIN email_links link ON t.link_id = link.id\n                WHERE m2.thread_id = $1\n                    AND (\n                        m2.is_sent = true -- condition 1\n                        OR l.name = 'IMPORTANT' -- condition 2\n                        OR (\n                            -- condition 3\n                            c.email_address IS NOT NULL\n                            AND RIGHT(c.email_address, LENGTH(RIGHT(link.email_address,\n                                LENGTH(link.email_address) - POSITION('@' IN link.email_address)))) =\n                            RIGHT(link.email_address, LENGTH(link.email_address) - POSITION('@' IN link.email_address))\n                        )\n                    )\n            )\n        ORDER BY a.id\n        ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "attachment_db_id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 1,
        "name": "email_provider_id!",
        "type_info": "Text"
      },
      {
        "ordinal": 2,
        "name": "provider_attachment_id!",
        "type_info": "Text"
      },
      {
        "ordinal": 3,
        "name": "filename!",
        "type_info": "Varchar"
      },
      {
        "ordinal": 4,
        "name": "mime_type!",
        "type_info": "Varchar"
      },
      {
        "ordinal": 5,
        "name": "internal_date_ts!",
        "type_info": "Timestamptz"
      }
    ],
    "parameters": {
      "Left": [
        "Uuid"
      ]
    },
    "nullable": [
      false,
      true,
      true,
      true,
      true,
      true
    ]
  },
  "hash": "bdbde20f0845ae3715f5593a3c5f080ad419b5ee924dc4c56ffdaf6612286e75"
}
