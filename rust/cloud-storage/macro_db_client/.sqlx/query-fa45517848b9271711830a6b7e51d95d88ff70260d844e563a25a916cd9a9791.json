{
  "db_name": "PostgreSQL",
  "query": "\n        WITH RECURSIVE ProjectHierarchy AS (\n            -- Find direct user access to projects first as starting point\n            SELECT\n                p.id,\n                uia.access_level\n            FROM \"Project\" p\n            JOIN \"UserItemAccess\" uia ON p.id = uia.item_id AND uia.item_type = 'project'\n            WHERE uia.user_id = $1 AND p.\"deletedAt\" IS NULL\n              AND ($3 = false OR p.\"userId\" != $1)  -- Exclude owned projects if exclude_owned = true\n\n            UNION ALL\n\n            -- Then walk down the project tree and grab child projects, keeping parent's access\n            SELECT\n                p.id,\n                ph.access_level\n            FROM \"Project\" p\n            JOIN ProjectHierarchy ph ON p.\"parentId\" = ph.id\n            WHERE p.\"deletedAt\" IS NULL\n              AND ($3 = false OR p.\"userId\" != $1)  -- Exclude owned projects if exclude_owned = true\n        ),\n        -- Now build up all the ways a user can have access to stuff\n        AllAccessGrants AS (\n            -- Explicit access to items via UserItemAccess table\n            SELECT uia.item_id, uia.item_type, uia.access_level\n            FROM \"UserItemAccess\" uia\n            -- We join to each table to check its \"deletedAt\" status.\n            -- This is more explicit and robust than using subqueries.\n            LEFT JOIN \"Document\" d ON uia.item_type = 'document' AND uia.item_id = d.id\n            LEFT JOIN \"Chat\" c ON uia.item_type = 'chat' AND uia.item_id = c.id\n            LEFT JOIN \"Project\" p ON uia.item_type = 'project' AND uia.item_id = p.id\n            WHERE uia.user_id = $1\n              AND ($2::text IS NULL OR uia.item_type = $2)\n              -- Rule: The item must not be deleted.\n              AND (\n                  (uia.item_type = 'document' AND d.\"deletedAt\" IS NULL) OR\n                  (uia.item_type = 'chat' AND c.\"deletedAt\" IS NULL) OR\n                  (uia.item_type = 'project' AND p.\"deletedAt\" IS NULL)\n              )\n              -- Rule: If exclude_owned is true, the user must not be the creator of the item.\n              AND ($3 = false OR (\n                  (uia.item_type = 'document' AND d.owner != $1) OR\n                  (uia.item_type = 'chat' AND c.\"userId\" != $1) OR\n                  (uia.item_type = 'project' AND p.\"userId\" != $1)\n              ))\n\n            -- The rest of the unions are to get implicit access to items via project access\n            UNION ALL\n\n            -- Access to docs in visible projects \n            SELECT\n                d.id AS item_id,\n                'document' AS item_type,\n                ph.access_level\n            FROM \"Document\" d\n            JOIN ProjectHierarchy ph ON d.\"projectId\" = ph.id\n            WHERE ($2::text IS NULL OR 'document' = $2)\n              AND d.\"projectId\" IS NOT NULL AND d.\"deletedAt\" IS NULL\n              AND ($3 = false OR d.owner != $1)\n\n            UNION ALL\n\n            -- Access to chats in visible projects\n            SELECT\n                c.id AS item_id,\n                'chat' AS item_type,\n                ph.access_level\n            FROM \"Chat\" c\n            JOIN ProjectHierarchy ph ON c.\"projectId\" = ph.id\n            WHERE ($2::text IS NULL OR 'chat' = $2)\n              AND c.\"projectId\" IS NOT NULL AND c.\"deletedAt\" IS NULL\n              AND ($3 = false OR c.\"userId\" != $1)\n\n            UNION ALL\n\n            -- Include the projects we found earlier\n            SELECT\n                ph.id AS item_id,\n                'project' AS item_type,\n                ph.access_level\n            FROM ProjectHierarchy ph\n            WHERE ($2::text IS NULL OR 'project' = $2)\n        ),\n        UserAccessibleItems AS (\n            SELECT\n                item_id,\n                item_type\n            FROM AllAccessGrants\n            GROUP BY item_id, item_type\n        )\n        SELECT item_id as \"item_id!\", item_type as \"item_type!\" FROM UserAccessibleItems\n        ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "item_id!",
        "type_info": "Text"
      },
      {
        "ordinal": 1,
        "name": "item_type!",
        "type_info": "Text"
      }
    ],
    "parameters": {
      "Left": [
        "Text",
        "Text",
        "Bool"
      ]
    },
    "nullable": [
      null,
      null
    ]
  },
  "hash": "fa45517848b9271711830a6b7e51d95d88ff70260d844e563a25a916cd9a9791"
}
