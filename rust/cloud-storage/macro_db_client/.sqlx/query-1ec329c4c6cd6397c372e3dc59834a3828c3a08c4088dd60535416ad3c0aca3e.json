{
  "db_name": "PostgreSQL",
  "query": "\n        WITH RECURSIVE ProjectHierarchy AS (\n            -- Find direct user access to ALL projects (not filtered) as starting point\n            SELECT\n                p.id,\n                uia.access_level\n            FROM \"Project\" p\n            JOIN \"UserItemAccess\" uia ON p.id = uia.item_id AND uia.item_type = 'project'\n            WHERE uia.user_id = $1 AND p.\"deletedAt\" IS NULL\n\n            UNION ALL\n\n            -- Then walk down the project tree and grab child projects, keeping parent's access\n            SELECT\n                p.id,\n                ph.access_level\n            FROM \"Project\" p\n            JOIN ProjectHierarchy ph ON p.\"parentId\" = ph.id\n            WHERE p.\"deletedAt\" IS NULL\n        ),\n        -- Now build up all the ways a user can have access to stuff\n        AllAccessGrants AS (\n            -- Explicit access to documents via UserItemAccess table\n            SELECT uia.item_id, uia.item_type, uia.access_level\n            FROM \"UserItemAccess\" uia\n            LEFT JOIN \"Document\" d ON uia.item_type = 'document' AND uia.item_id = d.id\n            WHERE uia.user_id = $1\n              AND uia.item_type = 'document'\n              AND uia.item_id = ANY($2)\n              AND d.\"deletedAt\" IS NULL\n\n            UNION ALL\n\n            -- Explicit access to chats via UserItemAccess table\n            SELECT uia.item_id, uia.item_type, uia.access_level\n            FROM \"UserItemAccess\" uia\n            LEFT JOIN \"Chat\" c ON uia.item_type = 'chat' AND uia.item_id = c.id\n            WHERE uia.user_id = $1\n              AND uia.item_type = 'chat'\n              AND uia.item_id = ANY($3)\n              AND c.\"deletedAt\" IS NULL\n\n            UNION ALL\n\n            -- Explicit access to projects via UserItemAccess table\n            SELECT uia.item_id, uia.item_type, uia.access_level\n            FROM \"UserItemAccess\" uia\n            LEFT JOIN \"Project\" p ON uia.item_type = 'project' AND uia.item_id = p.id\n            WHERE uia.user_id = $1\n              AND uia.item_type = 'project'\n              AND uia.item_id = ANY($4)\n              AND p.\"deletedAt\" IS NULL\n\n            UNION ALL\n\n            -- Access to docs in visible projects (only filter by requested doc IDs)\n            SELECT\n                d.id AS item_id,\n                'document' AS item_type,\n                ph.access_level\n            FROM \"Document\" d\n            JOIN ProjectHierarchy ph ON d.\"projectId\" = ph.id\n            WHERE d.id = ANY($2)\n              AND d.\"projectId\" IS NOT NULL \n              AND d.\"deletedAt\" IS NULL\n\n            UNION ALL\n\n            -- Access to chats in visible projects (only filter by requested chat IDs)\n            SELECT\n                c.id AS item_id,\n                'chat' AS item_type,\n                ph.access_level\n            FROM \"Chat\" c\n            JOIN ProjectHierarchy ph ON c.\"projectId\" = ph.id\n            WHERE c.id = ANY($3)\n              AND c.\"projectId\" IS NOT NULL \n              AND c.\"deletedAt\" IS NULL\n\n            UNION ALL\n\n            -- Include the projects we found earlier (only filter by requested project IDs)\n            SELECT\n                ph.id AS item_id,\n                'project' AS item_type,\n                ph.access_level\n            FROM ProjectHierarchy ph\n            WHERE ph.id = ANY($4)\n        ),\n        UserAccessibleItems AS (\n            SELECT\n                item_id,\n                item_type\n            FROM AllAccessGrants\n            GROUP BY item_id, item_type\n        )\n        SELECT item_id as \"item_id!\", item_type as \"item_type!\" FROM UserAccessibleItems\n        ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "item_id!",
        "type_info": "Text"
      },
      {
        "ordinal": 1,
        "name": "item_type!",
        "type_info": "Text"
      }
    ],
    "parameters": {
      "Left": [
        "Text",
        "TextArray",
        "TextArray",
        "TextArray"
      ]
    },
    "nullable": [
      null,
      null
    ]
  },
  "hash": "1ec329c4c6cd6397c372e3dc59834a3828c3a08c4088dd60535416ad3c0aca3e"
}
