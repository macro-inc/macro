{
  "db_name": "PostgreSQL",
  "query": "\n        WITH attachment_info AS (\n            SELECT\n                ca.id,\n                ca.\"attachmentType\",\n                ca.\"attachmentId\",\n                ca.\"messageId\",\n                CASE\n                    WHEN ca.\"attachmentType\" = 'document' THEN d.name\n                    WHEN ca.\"attachmentType\" = 'chat' THEN c.name\n                    WHEN ca.\"attachmentType\" = 'project' THEN p.name\n                    WHEN ca.\"attachmentType\" = 'image' THEN d.name\n                    ELSE NULL\n                END AS document_name,\n                CASE\n                    WHEN ca.\"attachmentType\" = 'document' THEN d.\"fileType\"\n                    WHEN ca.\"attachmentType\" = 'image' THEN d.\"fileType\"\n                    ELSE NULL\n                END as document_type\n            FROM\n                \"ChatAttachment\" ca\n            LEFT JOIN\n            \"Document\" d ON (\n                (ca.\"attachmentType\" = 'document' AND ca.\"attachmentId\" = d.id)\n                OR\n                (ca.\"attachmentType\" = 'image' AND ca.\"attachmentId\" = d.id)\n            )\n            LEFT JOIN\n                \"Chat\" c ON ca.\"attachmentType\" = 'chat' AND ca.\"attachmentId\" = c.id\n            LEFT JOIN\n                \"Project\" p ON ca.\"attachmentType\" = 'project' AND ca.\"attachmentId\" = p.id\n        )\n        SELECT\n            cm.id AS \"id!\",\n            cm.content,\n            cm.role,\n            cm.model,\n            COALESCE(\n                (\n                    SELECT json_agg(\n                        json_build_object(\n                            'id', attachment_info.\"attachmentId\",\n                            'attachmentType', attachment_info.\"attachmentType\",\n                            'attachmentId', attachment_info.\"attachmentId\",\n                            'documentName', attachment_info.document_name,\n                            'documentType', attachment_info.document_type\n                        )\n                    )\n                    FROM attachment_info\n                    WHERE attachment_info.\"messageId\" = cm.id\n                ),\n                '[]'::json\n            ) AS attachments\n        FROM\n            \"ChatMessage\" cm\n        WHERE\n            cm.\"chatId\" = $1\n        ORDER BY\n            cm.\"createdAt\" ASC\n    ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "id!",
        "type_info": "Text"
      },
      {
        "ordinal": 1,
        "name": "content",
        "type_info": "Jsonb"
      },
      {
        "ordinal": 2,
        "name": "role",
        "type_info": "Text"
      },
      {
        "ordinal": 3,
        "name": "model",
        "type_info": "Text"
      },
      {
        "ordinal": 4,
        "name": "attachments",
        "type_info": "Json"
      }
    ],
    "parameters": {
      "Left": [
        "Text"
      ]
    },
    "nullable": [
      false,
      false,
      false,
      true,
      null
    ]
  },
  "hash": "6df8edb2ab31514a1ad2e48eecc81d52bf70ec8e34a2741be8f7a7b521d5074a"
}
